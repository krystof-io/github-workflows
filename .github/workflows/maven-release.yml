# Simple Maven Release workflow - creates tags on current branch
# Location: github-workflows repo at .github/workflows/maven-release.yml
# This workflow runs maven release commands to create version tags and deploy artifacts
# The java-app-build workflow handles testing/building/deployment of the tagged version

name: Maven Release

on:
  workflow_call:
    inputs:
      maven_profiles:
        default: ''
        type: string
        description: 'Maven profiles to activate (comma-separated)'
      release_version:
        required: false
        type: string
        description: 'Override release version (e.g., 1.0.0). If not specified, Maven will determine automatically'
      next_development_version:
        required: false
        type: string
        description: 'Override next development version (e.g., 1.1.0-SNAPSHOT). If not specified, Maven will determine automatically'
      dry_run:
        default: false
        type: boolean
        description: 'Perform a dry run (no actual release)'
    secrets:
      MAVEN_REPO_USERNAME:
        required: true
      MAVEN_REPO_PASSWORD:
        required: true
      CICD_TOKEN:
        required: true
        description: 'Personal Access Token to trigger CI/CD workflows when tags are pushed'
      S3_CACHE_ACCESS_KEY:
        required: true
      S3_CACHE_SECRET_KEY:
        required: true

jobs:
  maven-release:
    runs-on: arc-runners-javadev
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        with:
          # Use Personal Access Token to allow triggering other workflows
          token: ${{ secrets.CICD_TOKEN }}

      - uses: krystof-io/cache@v4.3.0-1.0.0
        with:
          path: ~/.m2/repository
          key: maven-cache-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            maven-cache-          
        env:
          RUNS_ON_S3_BUCKET_CACHE: 'runner-caches'
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_CACHE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_CACHE_SECRET_KEY }}
          RUNS_ON_S3_BUCKET_ENDPOINT: ${{ vars.S3_CACHE_ENDPOINT }}
          RUNS_ON_AWS_REGION: 'default'
          RUNS_ON_S3_FORCE_PATH_STYLE: 'true'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Initialize Maven settings
        uses: s4u/maven-settings-action@v3.1.0
        with:
          servers: |
            [
            {"id": "private-snapshots", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "private-releases", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "nexus", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"}
            ]
          mirrors: |
            [
            {"id": "nexus", "name":"nexus", "mirrorOf":"*", "url":"${{ env.MAVEN_REPO_URL }}"}
            ]
          sonatypeSnapshots: true          
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
          MAVEN_REPO_URL: ${{ vars.MAVEN_REPO_URL }}

      - name: Show current project state
        run: |
          echo "ðŸ“‹ Current project state:"
          echo "Current version: $(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)"
          echo "Project name: $(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)"
          echo "Group ID: $(mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout)"
          echo "Current branch: $(git branch --show-current)"

      - name: Dry run - Show what would be released
        if: ${{ inputs.dry_run }}
        run: |
          echo "ðŸ” DRY RUN MODE - No changes will be made"
          echo ""
          
          PROFILES=""
          if [ -n "${{ inputs.maven_profiles }}" ]; then
            PROFILES="-P${{ inputs.maven_profiles }}"
          fi
          
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          
          if [ -n "${{ inputs.release_version }}" ] && [ -n "${{ inputs.next_development_version }}" ]; then
            RELEASE_VERSION="${{ inputs.release_version }}"
            NEXT_VERSION="${{ inputs.next_development_version }}"
            echo "Would release (override): ${RELEASE_VERSION}"
            echo "Next dev version (override): ${NEXT_VERSION}"
            echo "Tag: v${RELEASE_VERSION}"
            
            mvn release:prepare -DdryRun=true \
              -DreleaseVersion=${RELEASE_VERSION} \
              -DdevelopmentVersion=${NEXT_VERSION} \
              -Dtag=v${RELEASE_VERSION} \
              ${PROFILES}
          else
            AUTO_RELEASE_VERSION=${CURRENT_VERSION%-SNAPSHOT}
            echo "Would release: ${AUTO_RELEASE_VERSION} (Maven automatic)"
            echo "Tag: v${AUTO_RELEASE_VERSION}"
            
            mvn release:prepare -DdryRun=true \
              -Dtag=v${AUTO_RELEASE_VERSION} \
              ${PROFILES}
          fi
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}

      - name: Perform Maven release:prepare
        if: ${{ !inputs.dry_run }}
        run: |
          echo "ðŸš€ Performing Maven release:prepare..."
          
          PROFILES=""
          if [ -n "${{ inputs.maven_profiles }}" ]; then
            PROFILES="-P${{ inputs.maven_profiles }}"
          fi
          
          if [ -n "${{ inputs.release_version }}" ] && [ -n "${{ inputs.next_development_version }}" ]; then
            RELEASE_VERSION="${{ inputs.release_version }}"
            NEXT_VERSION="${{ inputs.next_development_version }}"
            TAG_NAME="v${RELEASE_VERSION}"
            
            echo "Using version overrides: ${RELEASE_VERSION} -> ${NEXT_VERSION}"
            
            mvn release:prepare \
              -DreleaseVersion=${RELEASE_VERSION} \
              -DdevelopmentVersion=${NEXT_VERSION} \
              -Dtag=${TAG_NAME} \
              -DpreparationGoals=validate \
              ${PROFILES}
          else
            CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
            AUTO_RELEASE_VERSION=${CURRENT_VERSION%-SNAPSHOT}
            TAG_NAME="v${AUTO_RELEASE_VERSION}"
            
            echo "Using automatic Maven versioning"
            echo "Release version: ${AUTO_RELEASE_VERSION}"
            echo "Tag: ${TAG_NAME}"
            
            mvn release:prepare \
              -Dtag=${TAG_NAME} \
              -DpreparationGoals=validate \
              ${PROFILES}
          fi
          
          # Store the tag name for the summary
          echo "CREATED_TAG=${TAG_NAME}" >> $GITHUB_ENV
          
          echo "âœ… Maven release:prepare completed successfully"
          echo "âœ… Tag ${TAG_NAME} has been created and pushed"
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}

      - name: Perform Maven release:perform
        if: ${{ !inputs.dry_run }}
        run: |
          echo "ðŸš€ Performing Maven release:perform..."
          
          PROFILES=""
          if [ -n "${{ inputs.maven_profiles }}" ]; then
            PROFILES="-P${{ inputs.maven_profiles }}"
          fi
          
          # Execute release:perform using local checkout (no need to checkout code again)
          mvn release:perform -DlocalCheckout=true ${PROFILES}
          
          echo "âœ… Maven release:perform completed successfully"
          echo "âœ… Release artifacts have been built and deployed to repository"
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}

      - name: Generate release summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "## ðŸŽ‰ Maven Release Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ inputs.dry_run }}" == "true" ]]; then
              echo "### ðŸ” Dry Run Completed" >> $GITHUB_STEP_SUMMARY
              echo "- **Mode**: Simulation only (no changes made)" >> $GITHUB_STEP_SUMMARY
              echo "- **Current Version**: $(mvn help:evaluate -Dexpression=project.version -q -DforceStdout 2>/dev/null || echo 'unknown')" >> $GITHUB_STEP_SUMMARY
            else
              echo "### ðŸš€ Release Completed Successfully" >> $GITHUB_STEP_SUMMARY
              echo "- **Git Tag**: ${CREATED_TAG:-unknown}" >> $GITHUB_STEP_SUMMARY
              echo "- **Branch**: $(git branch --show-current)" >> $GITHUB_STEP_SUMMARY
              echo "- **Current Version**: $(mvn help:evaluate -Dexpression=project.version -q -DforceStdout 2>/dev/null || echo 'unknown')" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
              echo "1. **ðŸš€ Automated Deployment**: The java-app-build workflow will trigger for tag \`${CREATED_TAG}\`" >> $GITHUB_STEP_SUMMARY
              echo "2. **ï¿½ Monitor**: Check the CI/CD pipeline for building and deployment progress" >> $GITHUB_STEP_SUMMARY
              echo "3. **ðŸ“ Release Notes**: Add release notes to the GitHub release if needed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ Maven Release Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Maven release process encountered an error. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ï¿½ï¸ Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "1. Check if the version already exists" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify Maven release plugin configuration in pom.xml" >> $GITHUB_STEP_SUMMARY
            echo "3. Ensure you have the necessary permissions" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Related Links" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“‹ Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]] && [[ "${{ inputs.dry_run }}" != "true" ]]; then
            echo "- [ðŸ·ï¸ Release Tag](https://github.com/${{ github.repository }}/releases/tag/${CREATED_TAG})" >> $GITHUB_STEP_SUMMARY
            echo "- [ï¿½ CI/CD Runs](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
          fi
