# Reusable workflow for running SonarQube analysis and OWASP dependency checks
# Location: github-workflows repo at .github/workflows/sonar-scan.yml

name: Sonar Scan

on:
  workflow_call:
    inputs:
      java_version:
        default: '25'
        type: string
        description: 'Java version to use'
      maven_profiles:
        default: ''
        type: string
        description: 'Maven profiles to activate (comma-separated)'
    outputs:
      sonar_status:
        description: 'SonarQube analysis status (passed/failed)'
        value: ${{ jobs.sonar-scan.outputs.sonar_status }}
      project_key:
        description: 'SonarQube project key'
        value: ${{ jobs.sonar-scan.outputs.project_key }}
      dashboard_url:
        description: 'SonarQube dashboard URL'
        value: ${{ jobs.sonar-scan.outputs.dashboard_url }}
      quality_gate_status:
        description: 'Quality gate status (OK/ERROR)'
        value: ${{ jobs.sonar-scan.outputs.quality_gate_status }}
      bugs:
        description: 'Number of bugs found'
        value: ${{ jobs.sonar-scan.outputs.bugs }}
      vulnerabilities:
        description: 'Number of security vulnerabilities found'
        value: ${{ jobs.sonar-scan.outputs.vulnerabilities }}
      code_smells:
        description: 'Number of code smells found'
        value: ${{ jobs.sonar-scan.outputs.code_smells }}
      coverage:
        description: 'Test coverage percentage'
        value: ${{ jobs.sonar-scan.outputs.coverage }}
    secrets:
      MAVEN_REPO_USERNAME:
        required: true
      MAVEN_REPO_PASSWORD:
        required: true
      SONAR_TOKEN:
        required: true
      NVD_API_KEY:
        required: true
      S3_CACHE_ACCESS_KEY:
        required: true
      S3_CACHE_SECRET_KEY:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  sonar-scan:
    runs-on: arc-runners-javadev
    outputs:
      sonar_status: ${{ steps.sonar.outputs.sonar_status }}
      project_key: ${{ steps.sonar.outputs.project_key }}
      dashboard_url: ${{ steps.sonar.outputs.dashboard_url }}
      quality_gate_status: ${{ steps.quality-gate.outputs.quality_gate_status }}
      bugs: ${{ steps.quality-gate.outputs.bugs }}
      vulnerabilities: ${{ steps.quality-gate.outputs.vulnerabilities }}
      code_smells: ${{ steps.quality-gate.outputs.code_smells }}
      coverage: ${{ steps.quality-gate.outputs.coverage }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        with:
          fetch-depth: 0
        
      - name: Initialize Maven settings
        uses: s4u/maven-settings-action@v3.1.0
        with:
          servers: |
            [
            {"id": "private-snapshots", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "private-releases", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "nexus", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"}
            ]
          mirrors: |
            [
            {"id": "nexus", "name":"nexus", "mirrorOf":"*", "url":"${{ env.MAVEN_REPO_URL }}"}
            ]
          sonatypeSnapshots: true          
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
          MAVEN_REPO_URL: ${{ vars.MAVEN_REPO_URL }}  
            
      - uses: krystof-io/cache@v4.3.0-1.0.0
        with:
          path: ~/.m2/repository
          key: maven-cache-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            maven-cache-
        env:
          RUNS_ON_S3_BUCKET_CACHE: 'runner-caches'
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_CACHE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_CACHE_SECRET_KEY }}
          RUNS_ON_S3_BUCKET_ENDPOINT: ${{ vars.S3_CACHE_ENDPOINT }}
          RUNS_ON_AWS_REGION: ${{ vars.S3_CACHE_REGION }}
          RUNS_ON_S3_FORCE_PATH_STYLE: 'true'
                    
      - uses: krystof-io/cache@v4.3.0-1.0.0
        with:
          path: ~/.m2/repository/org/owasp/dependency-check-data
          key: ${{ runner.os }}-owasp-data-${{ hashFiles('**/pom.xml') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-owasp-data-
        env:
          RUNS_ON_S3_BUCKET_CACHE: 'runner-caches'
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_CACHE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_CACHE_SECRET_KEY }}
          RUNS_ON_S3_BUCKET_ENDPOINT: ${{ vars.S3_CACHE_ENDPOINT }}
          RUNS_ON_AWS_REGION: ${{ vars.S3_CACHE_REGION }}
          RUNS_ON_S3_FORCE_PATH_STYLE: 'true'
          RUNS_ON_GLOBAL_CACHE_PREFIX: 'cache-global' # This gets shared across repos

      - name: Pre Sonar Build
        run: |
          PROFILES=""
          if [ -n "${{ inputs.maven_profiles }}" ]; then
            PROFILES="-P${{ inputs.maven_profiles }}"
          fi
          mvn clean verify ${PROFILES}
                    
      - name: Pre Sonar Dep Check
        run: |
          mvn org.owasp:dependency-check-maven:12.1.8:check \
            -Dformats=HTML,XML,JSON \
            -DnvdApiKey=${{ env.NVD_API_KEY }} \
            -DskipTests 
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}

      - name: Sonar Analysis with Quality Gate
        id: sonar
        run: |
          # Run SonarQube analysis
          set +e  # Don't exit on failure so we can capture results
          
          mvn org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.token=${{ env.SONAR_TOKEN }} \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.qualitygate.timeout=300
          
          SONAR_EXIT_CODE=$?
          
          # Extract project information from report-task.txt
          if [ -f "target/sonar/report-task.txt" ]; then
            PROJECT_KEY=$(grep "projectKey=" target/sonar/report-task.txt | cut -d'=' -f2)
            TASK_ID=$(grep "ceTaskId=" target/sonar/report-task.txt | cut -d'=' -f2)
            DASHBOARD_URL=$(grep "dashboardUrl=" target/sonar/report-task.txt | cut -d'=' -f2-)

            echo "project_key=${PROJECT_KEY}" >> $GITHUB_OUTPUT
            echo "task_id=${TASK_ID}" >> $GITHUB_OUTPUT
            echo "dashboard_url=${DASHBOARD_URL}" >> $GITHUB_OUTPUT
            
            echo "ðŸ“Š SonarQube Project: ${PROJECT_KEY}"
            echo "ðŸ”— Dashboard URL: ${DASHBOARD_URL}"
          else
            echo "âš ï¸ Could not find SonarQube report-task.txt file"
          fi
          
          # Set exit status
          if [ $SONAR_EXIT_CODE -ne 0 ]; then
            echo "sonar_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ SonarQube analysis failed or quality gate did not pass"
            exit $SONAR_EXIT_CODE
          else
            echo "sonar_status=passed" >> $GITHUB_OUTPUT
            echo "âœ… SonarQube analysis passed"
          fi
        env:
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Get Quality Gate Details
        id: quality-gate
        if: always() && steps.sonar.outputs.project_key != ''
        run: |
          # Get detailed quality gate information
          PROJECT_KEY="${{ steps.sonar.outputs.project_key }}"
          
          # Fetch quality gate status and conditions
          QG_RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "${{ vars.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=${PROJECT_KEY}")
          
          QG_STATUS=$(echo "$QG_RESPONSE" | jq -r '.projectStatus.status')
          echo "quality_gate_status=${QG_STATUS}" >> $GITHUB_OUTPUT
          
          # Get project metrics
          METRICS_RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "${{ vars.SONAR_HOST_URL }}/api/measures/component?component=${PROJECT_KEY}&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,ncloc")
          
          # Extract key metrics
          BUGS=$(echo "$METRICS_RESPONSE" | jq -r '.component.measures[] | select(.metric=="bugs") | .value // "0"')
          VULNERABILITIES=$(echo "$METRICS_RESPONSE" | jq -r '.component.measures[] | select(.metric=="vulnerabilities") | .value // "0"')
          CODE_SMELLS=$(echo "$METRICS_RESPONSE" | jq -r '.component.measures[] | select(.metric=="code_smells") | .value // "0"')
          COVERAGE=$(echo "$METRICS_RESPONSE" | jq -r '.component.measures[] | select(.metric=="coverage") | .value // "0"')
          DUPLICATION=$(echo "$METRICS_RESPONSE" | jq -r '.component.measures[] | select(.metric=="duplicated_lines_density") | .value // "0"')
          LINES_OF_CODE=$(echo "$METRICS_RESPONSE" | jq -r '.component.measures[] | select(.metric=="ncloc") | .value // "0"')
          
          echo "bugs=${BUGS}" >> $GITHUB_OUTPUT
          echo "vulnerabilities=${VULNERABILITIES}" >> $GITHUB_OUTPUT
          echo "code_smells=${CODE_SMELLS}" >> $GITHUB_OUTPUT
          echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
          echo "duplication=${DUPLICATION}" >> $GITHUB_OUTPUT
          echo "lines_of_code=${LINES_OF_CODE}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Quality Gate Status: ${QG_STATUS}"
          echo "ðŸ› Bugs: ${BUGS}"
          echo "ðŸ”’ Vulnerabilities: ${VULNERABILITIES}"
          echo "ðŸ“ Code Smells: ${CODE_SMELLS}"
          echo "ðŸŽ¯ Coverage: ${COVERAGE}%"
          echo "ðŸ“‹ Lines of Code: ${LINES_OF_CODE}"
        env:
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Create SonarQube Summary
        if: always() && steps.sonar.outputs.project_key != ''
        run: |
          PROJECT_KEY="${{ steps.sonar.outputs.project_key }}"
          DASHBOARD_URL="${{ steps.sonar.outputs.dashboard_url }}"
          
          # Create GitHub Actions job summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“Š SonarQube Analysis Results
          
          **Project:** \`${PROJECT_KEY}\`
          **Status:** ${{ steps.sonar.outputs.sonar_status == 'passed' && 'âœ… Quality Gate Passed' || 'âŒ Quality Gate Failed' }}
          
          ### ðŸ”— Links
          - [ðŸ“Š SonarQube Dashboard](${DASHBOARD_URL})
          - [ðŸŽ¯ Project Overview](${DASHBOARD_URL})
          
          ### ðŸ“ˆ Metrics
          | Metric | Value |
          |--------|-------|
          | ðŸ› Bugs | ${{ steps.quality-gate.outputs.bugs }} |
          | ðŸ”’ Security Vulnerabilities | ${{ steps.quality-gate.outputs.vulnerabilities }} |
          | ðŸ“ Code Smells | ${{ steps.quality-gate.outputs.code_smells }} |
          | ðŸŽ¯ Test Coverage | ${{ steps.quality-gate.outputs.coverage }}% |
          | ðŸ“‹ Lines of Code | ${{ steps.quality-gate.outputs.lines_of_code }} |
          | ðŸ”„ Duplication | ${{ steps.quality-gate.outputs.duplication }}% |
          
          EOF
          
          # Add failure details if quality gate failed
          if [ "${{ steps.sonar.outputs.sonar_status }}" = "failed" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### âŒ Quality Gate Failure
          
          The SonarQube quality gate failed. Please review the issues in the [SonarQube Dashboard](${{ steps.sonar.outputs.dashboard_url }}) and fix the identified problems before merging.
          
          **Next Steps:**
          1. ðŸ” Review the detailed analysis in SonarQube
          2. ðŸ”§ Fix critical bugs and security vulnerabilities
          3. ðŸ“ˆ Improve test coverage if below threshold
          4. ðŸ§¹ Address code quality issues
          
          EOF
          fi

      - name: Comment on Pull Request
        if: always() && steps.sonar.outputs.project_key != '' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const projectKey = '${{ steps.sonar.outputs.project_key }}';
            const sonarStatus = '${{ steps.sonar.outputs.sonar_status }}';
            const dashboardUrl = '${{ steps.sonar.outputs.dashboard_url }}';
            const bugs = '${{ steps.quality-gate.outputs.bugs }}';
            const vulnerabilities = '${{ steps.quality-gate.outputs.vulnerabilities }}';
            const codeSmells = '${{ steps.quality-gate.outputs.code_smells }}';
            const coverage = '${{ steps.quality-gate.outputs.coverage }}';
            const duplication = '${{ steps.quality-gate.outputs.duplication }}';
            const linesOfCode = '${{ steps.quality-gate.outputs.lines_of_code }}';
            
            const statusIcon = sonarStatus === 'passed' ? 'âœ…' : 'âŒ';
            const statusText = sonarStatus === 'passed' ? 'Quality Gate Passed' : 'Quality Gate Failed';
            
            const comment = `## ðŸ“Š SonarQube Analysis Results
            
            **Project:** \`${projectKey}\`
            **Status:** ${statusIcon} ${statusText}
            
            ### ðŸ”— Links
            - [ðŸ“Š SonarQube Dashboard](${dashboardUrl})
            - [ðŸŽ¯ Project Overview](${dashboardUrl})
            
            ### ðŸ“ˆ Metrics
            | Metric | Value |
            |--------|-------|
            | ðŸ› Bugs | ${bugs} |
            | ðŸ”’ Security Vulnerabilities | ${vulnerabilities} |
            | ðŸ“ Code Smells | ${codeSmells} |
            | ðŸŽ¯ Test Coverage | ${coverage}% |
            | ðŸ“‹ Lines of Code | ${linesOfCode} |
            | ðŸ”„ Duplication | ${duplication}% |
            
            ${sonarStatus === 'failed' ? `
            ### âŒ Action Required
            
            The SonarQube quality gate failed. Please review and fix the issues before merging:
            
            1. ðŸ” [Review detailed analysis](${dashboardUrl})
            2. ðŸ”§ Fix critical bugs and security vulnerabilities
            3. ðŸ“ˆ Improve test coverage if below threshold
            4. ðŸ§¹ Address code quality issues
            ` : ''}
            `;
            
            // Find existing SonarQube comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('ðŸ“Š SonarQube Analysis Results')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
