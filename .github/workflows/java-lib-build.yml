# Reusable workflow for building and publishing Java libraries
# Location: github-workflows repo at .github/workflows/java-lib-build.yml

name: Java Library Build and Publish

on:
  workflow_call:
    inputs:
      java_version:
        default: '21'
        type: string
        description: 'Java version to use'
      maven_profiles:
        default: ''
        type: string
        description: 'Maven profiles to activate (comma-separated)'
    secrets:
      MAVEN_REPO_USERNAME:
        required: true
      MAVEN_REPO_PASSWORD:
        required: true
      SONAR_TOKEN:
        required: true
      SONAR_HOST_URL:
        required: true
      NVD_API_KEY:
        required: true
      S3_CACHE_ACCESS_KEY:
        required: true
      S3_CACHE_SECRET_KEY:
        required: true

jobs:
  # Build and test the library
  build:
    runs-on: arc-runners-javadev
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_snapshot: ${{ steps.version.outputs.is_snapshot }}
      is_release: ${{ steps.version.outputs.is_release }}
      group_id: ${{ steps.version.outputs.group_id }}
      artifact_id: ${{ steps.version.outputs.artifact_id }}
      library_name: ${{ steps.version.outputs.library_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        
      - uses: krystof-io/cache@v4.3.0-1.0.0
        with:
          path: ~/.m2/repository
          key: maven-cache-${{ github.run_id }}-${{ github.run_attempt }}
        env:
          RUNS_ON_S3_BUCKET_CACHE: 'runner-caches'
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_CACHE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_CACHE_SECRET_KEY }}
          RUNS_ON_S3_BUCKET_ENDPOINT: ${{ vars.S3_CACHE_ENDPOINT }}
          RUNS_ON_AWS_REGION: 'default'
          RUNS_ON_S3_FORCE_PATH_STYLE: 'true'

      - name: Initialize Maven settings
        uses: s4u/maven-settings-action@v3.1.0
        with:
          servers: |
            [
            {"id": "private-snapshots", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "private-releases", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "nexus", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"}
            ]
          mirrors: |
            [
            {"id": "nexus", "name":"nexus", "mirrorOf":"*", "url":"${{ env.MAVEN_REPO_URL }}"}
            ]
          sonatypeSnapshots: true          
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
          MAVEN_REPO_URL: ${{ vars.MAVEN_REPO_URL }}          

      - name: Build and run tests
        run: |
          PROFILES=""
          if [ -n "${{ inputs.maven_profiles }}" ]; then
            PROFILES="-P${{ inputs.maven_profiles }}"
          fi
          mvn clean verify ${PROFILES}

      - name: Calculate version information
        id: version
        run: |
          # Extract Maven coordinates from pom.xml
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout || echo "unknown")
          GROUP_ID=$(mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout || echo "unknown")
          ARTIFACT_ID=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout || echo "unknown")
          
          # Create a display-friendly library name
          LIBRARY_NAME="${GROUP_ID}:${ARTIFACT_ID}"
          
          # Determine version type and release status
          if [[ "${VERSION}" == *"SNAPSHOT"* ]]; then
            IS_SNAPSHOT="true"
          else
            IS_SNAPSHOT="false"
          fi
          
          # Determine if this is a release (tag starting with 'v')
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            IS_RELEASE="true"
          else
            IS_RELEASE="false"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "group_id=${GROUP_ID}" >> $GITHUB_OUTPUT
          echo "artifact_id=${ARTIFACT_ID}" >> $GITHUB_OUTPUT
          echo "library_name=${LIBRARY_NAME}" >> $GITHUB_OUTPUT
          echo "is_snapshot=${IS_SNAPSHOT}" >> $GITHUB_OUTPUT
          echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT
          
          echo "Library: ${LIBRARY_NAME}"
          echo "Version: ${VERSION}"
          echo "Is snapshot: ${IS_SNAPSHOT}"
          echo "Is release: ${IS_RELEASE}"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/target/surefire-reports/
            **/target/failsafe-reports/
          retention-days: 7

  # Run Sonar scan
  sonar-scan:
    needs: [build]
    if: ${{ !contains(github.event.head_commit.message, 'prepare for next development iteration') && !contains(github.event.head_commit.message, '[maven-release-plugin]') }}
    uses: ./.github/workflows/sonar-scan.yml
    with:
      java_version: ${{ inputs.java_version }}
      maven_profiles: ${{ inputs.maven_profiles }}
    secrets:
      MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
      MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
      S3_CACHE_ACCESS_KEY: ${{ secrets.S3_CACHE_ACCESS_KEY }}
      S3_CACHE_SECRET_KEY: ${{ secrets.S3_CACHE_SECRET_KEY }}

  # Validate production release (only for releases)
  validate-prod-release:
    runs-on: arc-runners-javadev
    needs: [build, sonar-scan]
    if: ${{ needs.build.outputs.is_snapshot == 'false' && startsWith(github.ref, 'refs/tags/v') && (needs.sonar-scan.result == 'success' || needs.sonar-scan.result == 'skipped') }}
    steps:
      - name: Validate version is not SNAPSHOT
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          if [[ "${VERSION}" == *"SNAPSHOT"* ]]; then
            echo "ERROR: Cannot publish SNAPSHOT version as production release"
            exit 1
          fi
          echo "âœ… Version ${VERSION} is valid for production release"
      
      - name: Validate SonarQube passed for release
        run: |
          SONAR_RESULT="${{ needs.sonar-scan.result }}"
          if [[ "${SONAR_RESULT}" != "success" && "${SONAR_RESULT}" != "skipped" ]]; then
            echo "ERROR: SonarQube analysis must pass for production releases"
            echo "SonarQube result: ${SONAR_RESULT}"
            exit 1
          fi
          echo "âœ… SonarQube validation passed for production release"

  # Publish snapshots to Maven repository (no SonarQube requirement)
  publish-snapshot:
    runs-on: arc-runners-javadev
    needs: [build]
    if: ${{ needs.build.outputs.is_snapshot == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        
      - uses: krystof-io/cache@v4.3.0-1.0.0
        with:
          path: ~/.m2/repository
          key: maven-cache-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            maven-cache-          
        env:
          RUNS_ON_S3_BUCKET_CACHE: 'runner-caches'
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_CACHE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_CACHE_SECRET_KEY }}
          RUNS_ON_S3_BUCKET_ENDPOINT: ${{ vars.S3_CACHE_ENDPOINT }}
          RUNS_ON_AWS_REGION: 'default'
          RUNS_ON_S3_FORCE_PATH_STYLE: 'true'

      - name: Initialize Maven settings
        uses: s4u/maven-settings-action@v3.1.0
        with:
          servers: |
            [
            {"id": "private-snapshots", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "private-releases", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "nexus", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"}
            ]
          mirrors: |
            [
            {"id": "nexus", "name":"nexus", "mirrorOf":"*", "url":"${{ env.MAVEN_REPO_URL }}"}
            ]
          sonatypeSnapshots: true          
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
          MAVEN_REPO_URL: ${{ vars.MAVEN_REPO_URL }}   

      - name: Deploy SNAPSHOT to Maven repository
        run: |
          PROFILES=""
          if [ -n "${{ inputs.maven_profiles }}" ]; then
            PROFILES="-P${{ inputs.maven_profiles }}"
          fi
          mvn deploy -DskipTests ${PROFILES} \
            -DaltSnapshotDeploymentRepository=private-snapshots::${{ vars.MAVEN_PRIVATE_SNAPSHOT_REPO_URL }} \
            -DaltReleaseDeploymentRepository=private-releases::${{ vars.MAVEN_PRIVATE_RELEASE_REPO_URL }}
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
      
      - name: Publish SNAPSHOT summary
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          LIBRARY_NAME="${{ needs.build.outputs.library_name }}"
          GROUP_ID="${{ needs.build.outputs.group_id }}"
          ARTIFACT_ID="${{ needs.build.outputs.artifact_id }}"
          REPO_URL="${{ vars.MAVEN_PRIVATE_SNAPSHOT_REPO_URL }}"
          
          echo "## ðŸ“¦ Maven SNAPSHOT Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Library**: \`${LIBRARY_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Group ID**: \`${GROUP_ID}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact ID**: \`${ARTIFACT_ID}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: SNAPSHOT" >> $GITHUB_STEP_SUMMARY
          echo "- **Target URL**: ${REPO_URL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ SNAPSHOT published without SonarQube validation requirement" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully published to Maven SNAPSHOT repository" >> $GITHUB_STEP_SUMMARY

  # Publish releases to Maven repository (requires SonarQube to pass)
  publish-release:
    runs-on: arc-runners-javadev
    needs: [build, validate-prod-release]
    if: ${{ needs.build.outputs.is_snapshot == 'false' && startsWith(github.ref, 'refs/tags/v') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        
      - uses: krystof-io/cache@v4.3.0-1.0.0
        with:
          path: ~/.m2/repository
          key: maven-cache-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            maven-cache-          
        env:
          RUNS_ON_S3_BUCKET_CACHE: 'runner-caches'
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_CACHE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_CACHE_SECRET_KEY }}
          RUNS_ON_S3_BUCKET_ENDPOINT: ${{ vars.S3_CACHE_ENDPOINT }}
          RUNS_ON_AWS_REGION: 'default'
          RUNS_ON_S3_FORCE_PATH_STYLE: 'true'

      - name: Initialize Maven settings
        uses: s4u/maven-settings-action@v3.1.0
        with:
          servers: |
            [
            {"id": "private-snapshots", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "private-releases", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "nexus", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"}
            ]
          mirrors: |
            [
            {"id": "nexus", "name":"nexus", "mirrorOf":"*", "url":"${{ env.MAVEN_REPO_URL }}"}
            ]
          sonatypeSnapshots: true          
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
          MAVEN_REPO_URL: ${{ vars.MAVEN_REPO_URL }}   

      - name: Deploy RELEASE to Maven repository
        run: |
          PROFILES=""
          if [ -n "${{ inputs.maven_profiles }}" ]; then
            PROFILES="-P${{ inputs.maven_profiles }}"
          fi
          mvn deploy -DskipTests ${PROFILES} \
            -DaltSnapshotDeploymentRepository=private-snapshots::${{ vars.MAVEN_PRIVATE_SNAPSHOT_REPO_URL }} \
            -DaltReleaseDeploymentRepository=private-releases::${{ vars.MAVEN_PRIVATE_RELEASE_REPO_URL }}
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
      
      - name: Publish RELEASE summary
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          LIBRARY_NAME="${{ needs.build.outputs.library_name }}"
          GROUP_ID="${{ needs.build.outputs.group_id }}"
          ARTIFACT_ID="${{ needs.build.outputs.artifact_id }}"
          REPO_URL="${{ vars.MAVEN_PRIVATE_RELEASE_REPO_URL }}"
          
          echo "## ðŸ“¦ Maven RELEASE Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Library**: \`${LIBRARY_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Group ID**: \`${GROUP_ID}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact ID**: \`${ARTIFACT_ID}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: RELEASE" >> $GITHUB_STEP_SUMMARY
          echo "- **Target URL**: ${REPO_URL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… SonarQube quality gate passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully published to Maven RELEASE repository" >> $GITHUB_STEP_SUMMARY