# Workflow to validate flux deployments after gitops reconciliation
# Location: github-workflows repo at .github/workflows/validate-flux-deployment.yml

name: Validate Flux Deployment

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
        description: 'Name of the application'
      image_tag:
        required: true
        type: string
        description: 'Expected Docker image tag'
      target_namespace:
        required: true
        type: string
        description: 'Target namespace'
      cluster_name:
        required: true
        type: string
        description: 'Name of the target cluster'
      validation_timeout:
        default: 600
        type: number
        description: 'Timeout in seconds for deployment validation'
      cluster_url:
        required: true
        type: string
        description: 'Kubernetes cluster server URL'
    secrets:
      CLUSTER_CA_CERTIFICATE:
        description: 'Base64 encoded cluster CA certificate'
        required: true
      SERVICE_ACCOUNT_TOKEN:
        description: 'Service account token for cluster access'
        required: true

jobs:
  validate-deployment:
    runs-on: arc-runners-javadev
    steps:
      - name: Setup kubectl
        run: |
          echo "ðŸ”§ Setting up kubectl for deployment validation..."
          
          # Verify kubectl is available
          if ! command -v kubectl &> /dev/null; then
            echo "âŒ kubectl not found"
            exit 1
          fi
          
          CLUSTER_NAME="${{ inputs.cluster_name }}"
          
          # Using Service Account token
          echo "ðŸ”‘ Configuring kubectl using service account token..."
          
          # Set up cluster configuration
          kubectl config set-cluster "${CLUSTER_NAME}" \
            --server="${{ inputs.cluster_url }}" \
            --insecure-skip-tls-verify=false
          
          # Add CA certificate if provided
          if [[ -n "${{ secrets.CLUSTER_CA_CERTIFICATE }}" ]]; then
            echo "ðŸ” Adding cluster CA certificate..."
            echo "${{ secrets.CLUSTER_CA_CERTIFICATE }}" | base64 -d > /tmp/ca.crt
            
            # Validate the CA certificate format
            if openssl x509 -in /tmp/ca.crt -noout -text >/dev/null 2>&1; then
              echo "âœ… CA certificate format is valid"
              
              # Show certificate details for debugging
              echo "ðŸ“‹ CA Certificate Details:"
              openssl x509 -in /tmp/ca.crt -noout -subject -issuer -enddate 2>/dev/null || echo "  (Details not available)"
              
              kubectl config set-cluster "${CLUSTER_NAME}" \
                --certificate-authority=/tmp/ca.crt \
                --embed-certs=true
            else
              echo "âŒ Invalid CA certificate format"
              echo "The provided CLUSTER_CA_CERTIFICATE secret does not contain a valid X.509 certificate"
              rm -f /tmp/ca.crt
              exit 1
            fi
            rm -f /tmp/ca.crt
          else
            echo "âš ï¸  No CA certificate provided - using insecure connection"
            kubectl config set-cluster "${CLUSTER_NAME}" \
              --insecure-skip-tls-verify=true
          fi
          
          # Set up user credentials
          kubectl config set-credentials "cicd-k8s-access" \
            --token="${{ secrets.SERVICE_ACCOUNT_TOKEN }}"
          
          # Set up context
          kubectl config set-context "${CLUSTER_NAME}" \
            --cluster="${CLUSTER_NAME}" \
            --user="cicd-k8s-access"
          
          # Use the context
          kubectl config use-context "${CLUSTER_NAME}"
          
          # Verify connection with a simple command that uses our actual permissions
          echo "ðŸ” Testing kubectl connectivity..."
          if kubectl auth can-i get deployments >/dev/null 2>&1; then
            echo "âœ… kubectl configured successfully using service account for cluster: ${CLUSTER_NAME}"
          else
            echo "âŒ Failed to connect to cluster ${CLUSTER_NAME} using service account"
            echo ""
            echo "ðŸ” Debugging Information:"
            echo "  Server URL: ${{ inputs.cluster_url }}"
            echo "  CA Certificate provided: $([ -n '${{ secrets.CLUSTER_CA_CERTIFICATE }}' ] && echo 'Yes' || echo 'No')"
            echo "  Service Account Token provided: $([ -n '${{ secrets.SERVICE_ACCOUNT_TOKEN }}' ] && echo 'Yes' || echo 'No')"
            echo ""
            echo "ðŸš¨ Common causes:"
            echo "  1. CA certificate doesn't match cluster's actual CA"
            echo "  2. Cluster server URL is incorrect"
            echo "  3. Service account token is expired or invalid"
            echo "  4. Network connectivity issues"
            echo "  5. Cluster API server is not accessible"
            echo ""
            echo "ðŸ“‹ To debug:"
            echo "  - Verify CA certificate: kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.certificate-authority-data}'"
            echo "  - Test connectivity: curl -k ${{ inputs.cluster_url }}/version"
            echo "  - Check service account: kubectl auth can-i get deployments --as=system:serviceaccount:flux-system:cicd-k8s-access"
            exit 1
          fi
          

      - name: Validate deployment
        run: |
          set -e
          
          APP_NAME="${{ inputs.app_name }}"
          IMAGE_TAG="${{ inputs.image_tag }}"
          NAMESPACE="${{ inputs.target_namespace }}"
          CLUSTER_NAME="${{ inputs.cluster_name }}"
          TIMEOUT_SECONDS="${{ inputs.validation_timeout }}"
          
          echo "ðŸ” Starting production deployment validation..."
          echo "ðŸ“‹ Validation parameters:"
          echo "  App: ${APP_NAME}"
          echo "  Expected Image: ${IMAGE_TAG}"
          echo "  Namespace: ${NAMESPACE}"
          echo "  Cluster: ${CLUSTER_NAME}"
          echo "  Timeout: ${TIMEOUT_SECONDS}s"
          
          # First check if deployment needs to change (avoid false positives)
          echo "ðŸ” Checking current deployment state..."
          CURRENT_IMAGE=$(kubectl get deployment ${APP_NAME} -n ${NAMESPACE} --context=${CLUSTER_NAME} -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "")
          
          if [[ -n "${CURRENT_IMAGE}" && "${CURRENT_IMAGE}" == *":${IMAGE_TAG}" ]]; then
            echo "â„¹ï¸  Deployment already has expected image: ${CURRENT_IMAGE}"
            echo "âœ… No deployment change needed - validation passed"
            exit 0
          elif [[ -n "${CURRENT_IMAGE}" ]]; then
            echo "ðŸ”„ Current image: ${CURRENT_IMAGE}"
            echo "ðŸŽ¯ Target image: *:${IMAGE_TAG}"
            echo "â³ Waiting for Flux to reconcile and deploy new image..."
          fi
          
          # Wait for deployment to be ready (includes readiness probes)
          echo "ðŸ“¦ Waiting for deployment rollout (including readiness probes)..."
          if timeout ${TIMEOUT_SECONDS} kubectl rollout status deployment/${APP_NAME} -n ${NAMESPACE} --context=${CLUSTER_NAME}; then
            echo "âœ… Deployment rollout completed"
          else
            echo "âŒ Deployment rollout failed or timed out"
            kubectl get deployment ${APP_NAME} -n ${NAMESPACE} --context=${CLUSTER_NAME} -o wide
            kubectl get pods -n ${NAMESPACE} -l app=${APP_NAME} --context=${CLUSTER_NAME}
            exit 1
          fi
          
          # Verify image tag is correct with retry logic
          echo "ðŸ·ï¸  Verifying deployed image tag..."
          IMAGE_VERIFIED=false
          RETRY_COUNT=0
          MAX_RETRIES=30  # 5 minutes with 10s intervals
          
          while [[ ${RETRY_COUNT} -lt ${MAX_RETRIES} && "${IMAGE_VERIFIED}" == "false" ]]; do
            DEPLOYED_IMAGE=$(kubectl get deployment ${APP_NAME} -n ${NAMESPACE} --context=${CLUSTER_NAME} -o jsonpath='{.spec.template.spec.containers[0].image}')
            echo "Deployed image: ${DEPLOYED_IMAGE}"
            
            if [[ "${DEPLOYED_IMAGE}" == *":${IMAGE_TAG}" ]]; then
              echo "âœ… Image tag verification passed"
              IMAGE_VERIFIED=true
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â³ Image not yet updated (${RETRY_COUNT}/${MAX_RETRIES}). Waiting for Flux reconciliation..."
              sleep 10
            fi
          done
          
          if [[ "${IMAGE_VERIFIED}" == "false" ]]; then
            echo "âŒ Image tag verification failed after ${MAX_RETRIES} retries!"
            echo "Expected tag: ${IMAGE_TAG}"
            echo "Final deployed image: ${DEPLOYED_IMAGE}"
            echo "This could indicate:"
            echo "  - Flux reconciliation is delayed"
            echo "  - GitOps repository update failed"
            echo "  - Image pull issues"
            exit 1
          fi
          
          # Show final pod status
          echo "ðŸ“Š Final deployment status:"
          kubectl get deployment ${APP_NAME} -n ${NAMESPACE} --context=${CLUSTER_NAME} -o wide
          kubectl get pods -n ${NAMESPACE} -l app=${APP_NAME} --context=${CLUSTER_NAME} -o wide
          
          echo "ðŸŽ‰ Production deployment validation completed successfully!"

      - name: Report validation results
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "## âœ… Production Deployment Validation - PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Validation Results" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Deployment Status**: Ready" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Image Verification**: Correct tag deployed" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Pod Health**: All pods ready" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Service Health**: Health checks passing" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Deployment Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Application**: ${{ inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Image Tag**: ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Namespace**: ${{ inputs.target_namespace }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Cluster**: ${{ inputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Production Deployment Validation - FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš¨ Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "The production deployment validation failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. **Check Deployment Status**: \`kubectl get deployment ${{ inputs.app_name }} -n ${{ inputs.target_namespace }}\`" >> $GITHUB_STEP_SUMMARY
            echo "2. **Check Pod Status**: \`kubectl get pods -n ${{ inputs.target_namespace }} -l app=${{ inputs.app_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "3. **Check Pod Logs**: \`kubectl logs -n ${{ inputs.target_namespace }} -l app=${{ inputs.app_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "4. **Check Events**: \`kubectl get events -n ${{ inputs.target_namespace }}\`" >> $GITHUB_STEP_SUMMARY
          fi
