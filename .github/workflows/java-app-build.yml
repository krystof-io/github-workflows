# Reusable workflow for building and deploying Java Spring Boot applications
# Location: github-workflows repo at .github/workflows/java-app-build.yml

name: Java App Build and Deploy

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
        description: 'Name of the application'
      java_version:
        default: '25'
        type: string
        description: 'Java version to use'
      maven_profiles:
        default: ''
        type: string
        description: 'Maven profiles to activate (comma-separated)'
      target_clusters:
        default: '[]'
        type: string
        description: 'JSON array of target clusters'
      dockerfile_repo:
        default: 'krystof-io/devops-templates'
        type: string
        description: 'Repository containing shared Dockerfiles'
      dockerfile_path:
        default: 'Dockerfiles/java/spring-boot/Dockerfile'
        type: string
        description: 'Path to Dockerfile within dockerfile_repo'
      base_docker_image:
        default: 'eclipse-temurin:25-jre-alpine'
        type: string
        description: 'Base image for Docker build'
      openapi_spec_path:
        default: 'target/openapi.yaml'
        type: string
        description: 'Path to OpenAPI spec file (auto-published if exists)'
      api_registry_repo:
        default: 'krystof-io/api-registry'
        type: string
        description: 'API registry repository for OpenAPI specs'
    secrets:
      IMAGE_REGISTRY_USERNAME:
        required: true
      IMAGE_REGISTRY_PASSWORD:
        required: true
      MAVEN_REPO_USERNAME:
        required: true
      MAVEN_REPO_PASSWORD:
        required: true
      SONAR_TOKEN:
        required: true
      NVD_API_KEY:
        required: true
      S3_CACHE_ACCESS_KEY:
        required: true
      S3_CACHE_SECRET_KEY:
        required: true              
      CICD_TOKEN:
        required: true
      CICD_USER_EMAIL:
        required: true
      CICD_USER_NAME:
        required: true

permissions:
  contents: read
  pull-requests: write
  
jobs:
  # Parse cluster configuration and setup matrix
  build:
    runs-on: arc-runners-javadev
    outputs:
      clusters_matrix: ${{ steps.parse.outputs.matrix }}
      has_clusters: ${{ steps.parse.outputs.has_clusters }}
      version: ${{ steps.version.outputs.version }}
      image_tag: ${{ steps.version.outputs.image_tag }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        
      - name: Checkout workflow repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        with:
          repository: krystof-io/github-workflows
          path: workflow-config
      
      - name: Parse target clusters
        id: parse
        run: |
          cd workflow-config
          # Read cluster config
          CLUSTERS_CONFIG=$(cat config/clusters.yml | yq -o json)
          
          # Parse input clusters
          TARGET_CLUSTERS='${{ inputs.target_clusters }}'
          
          # Build matrix with GitOps repo for each cluster
          MATRIX=$(echo $TARGET_CLUSTERS | jq -c --argjson config "$CLUSTERS_CONFIG" '
            map({
              name: .,
              gitops_repo: $config.clusters[.].gitops_repo,
              cluster_path: $config.clusters[.].cluster_path,
              cluster_url: $config.clusters[.].cluster_url
            })
          ')
          echo "matrix={\"include\":$MATRIX}" >> $GITHUB_OUTPUT
          
          # Check if we have any clusters to deploy to
          HAS_CLUSTERS=$(echo $TARGET_CLUSTERS | jq 'length > 0')
          echo "has_clusters=$HAS_CLUSTERS" >> $GITHUB_OUTPUT

      - uses: krystof-io/cache@v4.3.0-1.0.0
        with:
          path: ~/.m2/repository
          key: maven-cache-${{ github.run_id }}-${{ github.run_attempt }}
        env:
          RUNS_ON_S3_BUCKET_CACHE: 'runner-caches'
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_CACHE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_CACHE_SECRET_KEY }}
          RUNS_ON_S3_BUCKET_ENDPOINT: ${{ vars.S3_CACHE_ENDPOINT }}
          RUNS_ON_AWS_REGION: ${{ vars.S3_CACHE_REGION }}
          RUNS_ON_S3_FORCE_PATH_STYLE: 'true'

      - name: Initialize Maven settings
        uses: s4u/maven-settings-action@v3.1.0
        with:
          servers: |
            [
            {"id": "private-snapshots", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "private-releases", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "nexus", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"}
            ]
          mirrors: |
            [
            {"id": "nexus", "name":"nexus", "mirrorOf":"*", "url":"${{ env.MAVEN_REPO_URL }}"}
            ]
          sonatypeSnapshots: true          
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
          MAVEN_REPO_URL: ${{ vars.MAVEN_REPO_URL }}          

      - name: Build and run tests
        run: |
          PROFILES=""
          if [ -n "${{ inputs.maven_profiles }}" ]; then
            PROFILES="-P${{ inputs.maven_profiles }}"
          fi
          mvn clean verify ${PROFILES}

      - name: Calculate version and image tag
        id: version
        run: |
          # Extract version from pom.xml
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout || echo "unknown")
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          # Determine if this is a release (tag starting with 'v')
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            IS_RELEASE="true"
            # For releases, use clean version (no SNAPSHOT)
            IMAGE_TAG="${VERSION}"
          elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
            IS_RELEASE="false"
            # For main branch
            IMAGE_TAG="${VERSION}-${SHORT_SHA}"
          else
            IS_RELEASE="false"
            # For feature branches
            BRANCH_NAME=$(echo ${{ github.ref }} | sed 's|refs/heads/||' | sed 's/[^a-zA-Z0-9]/-/g')
            IMAGE_TAG="${VERSION}-${BRANCH_NAME}-${SHORT_SHA}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT
          
          echo "Version: ${VERSION}"
          echo "Image Tag: ${IMAGE_TAG}"
          echo "Is Release: ${IS_RELEASE}"

      - name: Build Summary
        run: |
          APP_NAME="${{ inputs.app_name }}"
          VERSION="${{ steps.version.outputs.version }}"
          IMAGE_TAG="${{ steps.version.outputs.image_tag }}"
          IS_RELEASE="${{ steps.version.outputs.is_release }}"
          HAS_CLUSTERS="${{ steps.parse.outputs.has_clusters }}"
          JAVA_VERSION="${{ inputs.java_version }}"
          MAVEN_PROFILES="${{ inputs.maven_profiles }}"
          
          echo "## ðŸš€ Java Application Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Application**: \`${APP_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Java Version**: \`${JAVA_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${MAVEN_PROFILES}" ]; then
            echo "- **Maven Profiles**: \`${MAVEN_PROFILES}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Release Build**: ${IS_RELEASE}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Target Clusters**: ${HAS_CLUSTERS}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${IS_RELEASE}" == "true" ]]; then
            echo "ðŸŽ¯ **Production Release Build** - Will deploy to production environment" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ðŸ”§ **Main Branch Build** - Will deploy to development environment" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŒ¿ **Feature Branch Build** - Development build only" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build and tests completed successfully" >> $GITHUB_STEP_SUMMARY

      - name: Upload OpenAPI spec artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: ${{ inputs.openapi_spec_path }}
          if-no-files-found: ignore
          retention-days: 1

  # Build Docker image
  build-docker-image:
    runs-on: arc-runners-javadev
    needs: [build]
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        
      - name: Checkout dockerfile repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        with:
          repository: ${{ inputs.dockerfile_repo }}
          path: docker-templates

      - uses: krystof-io/cache@v4.3.0-1.0.0
        with:
          path: ~/.m2/repository
          key: maven-cache-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            maven-cache-          
        env:
          RUNS_ON_S3_BUCKET_CACHE: 'runner-caches'
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_CACHE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_CACHE_SECRET_KEY }}
          RUNS_ON_S3_BUCKET_ENDPOINT: ${{ vars.S3_CACHE_ENDPOINT }}
          RUNS_ON_AWS_REGION: ${{ vars.S3_CACHE_REGION }}
          RUNS_ON_S3_FORCE_PATH_STYLE: 'true'

      - name: Initialize Maven settings
        uses: s4u/maven-settings-action@v3.1.0
        with:
          servers: |
            [
            {"id": "private-snapshots", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "private-releases", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"},
            {"id": "nexus", "username": "${{ env.MAVEN_REPO_USERNAME }}", "password": "${{ env.MAVEN_REPO_PASSWORD }}"}
            ]
          mirrors: |
            [
            {"id": "nexus", "name":"nexus", "mirrorOf":"*", "url":"${{ env.MAVEN_REPO_URL }}"}
            ]
          sonatypeSnapshots: true          
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
          MAVEN_REPO_URL: ${{ vars.MAVEN_REPO_URL }}   

      - name: Package application
        run: |
          PROFILES=""
          if [ -n "${{ inputs.maven_profiles }}" ]; then
            PROFILES="-P${{ inputs.maven_profiles }}"
          fi
          mvn package -DskipTests ${PROFILES}
        env:
          MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
          MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
      
      - name: Find JAR file
        id: find_jar
        run: |
          JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          echo "jar_file=${JAR_FILE}" >> $GITHUB_OUTPUT
          echo "Found JAR: ${JAR_FILE}"
      
      - name: Login to internal private docker repo
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef #v3.6.0
        with:
          registry: ${{ vars.IMAGE_REGISTRY_HOST }}
          username: ${{ secrets.IMAGE_REGISTRY_USERNAME }}
          password: ${{ secrets.IMAGE_REGISTRY_PASSWORD }}
      
      - name: Build and push Docker image
        run: |
          IMAGE_NAME="${{ vars.IMAGE_REGISTRY_HOST }}/krystof-io/${{ inputs.app_name }}:${{ needs.build.outputs.image_tag }}"
          
          docker build \
            -f docker-templates/${{ inputs.dockerfile_path }} \
            --build-arg BASE_IMAGE=${{ inputs.base_docker_image }} \
            --build-arg JAR_FILE=${{ steps.find_jar.outputs.jar_file }} \
            -t "${IMAGE_NAME}" \
            .
          
          docker push "${IMAGE_NAME}"

      - name: Docker Build Summary
        run: |
          APP_NAME="${{ inputs.app_name }}"
          IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
          BASE_IMAGE="${{ inputs.base_docker_image }}"
          JAR_FILE="${{ steps.find_jar.outputs.jar_file }}"
          IMAGE_NAME="${{ vars.IMAGE_REGISTRY_HOST }}/krystof-io/${{ inputs.app_name }}:${{ needs.build.outputs.image_tag }}"
          DOCKERFILE_PATH="${{ inputs.dockerfile_path }}"
          
          echo "## ðŸ³ Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Application**: \`${APP_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Name**: \`${IMAGE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Base Image**: \`${BASE_IMAGE}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **JAR File**: \`${JAR_FILE}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Dockerfile**: \`${DOCKERFILE_PATH}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${{ vars.IMAGE_REGISTRY_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker image built and pushed successfully" >> $GITHUB_STEP_SUMMARY

  # Run Sonar scan
  sonar-scan:
    needs: [build]
    if: ${{ !contains(github.event.head_commit.message, 'prepare for next development iteration') }}
    uses: ./.github/workflows/sonar-scan.yml
    with:
      java_version: ${{ inputs.java_version }}
      maven_profiles: ${{ inputs.maven_profiles }}
    secrets:
      MAVEN_REPO_USERNAME: ${{ secrets.MAVEN_REPO_USERNAME }}
      MAVEN_REPO_PASSWORD: ${{ secrets.MAVEN_REPO_PASSWORD }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
      S3_CACHE_ACCESS_KEY: ${{ secrets.S3_CACHE_ACCESS_KEY }}
      S3_CACHE_SECRET_KEY: ${{ secrets.S3_CACHE_SECRET_KEY }}

  # Publish OpenAPI spec to API registry (auto-detected)
  publish-openapi:
    needs: [build]
    if: ${{ !contains(github.event.head_commit.message, 'prepare for next development iteration') }}
    uses: ./.github/workflows/publish-openapi-spec.yml
    with:
      app_name: ${{ inputs.app_name }}
      spec_path: ${{ inputs.openapi_spec_path }}
      api_registry_repo: ${{ inputs.api_registry_repo }}
      version: ${{ needs.build.outputs.version }}
    secrets:
      CICD_TOKEN: ${{ secrets.CICD_TOKEN }}
      CICD_USER_EMAIL: ${{ secrets.CICD_USER_EMAIL }}
      CICD_USER_NAME: ${{ secrets.CICD_USER_NAME }}

  # Deploy to dev environment (direct commit)
  deploy-dev:
    name: deploy (${{ matrix.name }})
    needs: [build, build-docker-image]
    if: ${{ !startsWith(github.ref, 'refs/tags/v') && needs.build.outputs.has_clusters == 'true' }}
    strategy:
      matrix: ${{ fromJson(needs.build.outputs.clusters_matrix) }}
    uses: ./.github/workflows/flux-deploy.yml
    with:
      app_name: ${{ inputs.app_name }}
      image_tag: ${{ needs.build.outputs.image_tag }}
      target_namespace: "dev"
      gitops_repo: ${{ matrix.gitops_repo }}
      cluster_path: ${{ matrix.cluster_path }}
      cluster_name: ${{ matrix.name }}
    secrets:
      CICD_TOKEN: ${{ secrets.CICD_TOKEN }}
      CICD_USER_EMAIL: ${{ secrets.CICD_USER_EMAIL }}
      CICD_USER_NAME: ${{ secrets.CICD_USER_NAME }}

  # Validate dev deployment
  validate-dev-deployment:
    name: validate-deployment (${{ matrix.name }})
    needs: [build, deploy-dev]
    if: ${{ !startsWith(github.ref, 'refs/tags/v') && needs.build.outputs.has_clusters == 'true' }}
    strategy:
      matrix: ${{ fromJson(needs.build.outputs.clusters_matrix) }}
    uses: ./.github/workflows/validate-flux-deployment.yml
    with:
      app_name: ${{ inputs.app_name }}
      image_tag: ${{ needs.build.outputs.image_tag }}
      target_namespace: "dev"
      cluster_name: ${{ matrix.name }}
      validation_timeout: 600
      cluster_url: ${{ matrix.cluster_url }}
    secrets:
      # Pass cluster-specific secrets (these would be configured per cluster)
      CLUSTER_CA_CERTIFICATE: ${{ secrets[format('K8S_CLUSTER_CA_CERT_FOR_{0}_CLUSTER', matrix.name)] }}
      SERVICE_ACCOUNT_TOKEN: ${{ secrets[format('SERVICE_ACCOUNT_TOKEN_FOR_{0}_CLUSTER_CICD_K8S_ACCESS', matrix.name)] }}

  # Validate production release
  validate-prod-release:
    runs-on: arc-runners-javadev
    needs: [build, sonar-scan, build-docker-image]
    if: startsWith(github.ref, 'refs/tags/v')
  # asdf ${{ startsWith(github.ref, 'refs/tags/v') && (needs.sonar-scan.result == 'success' || needs.sonar-scan.result == 'skipped') }}
    steps:
      - name: Validate version is not SNAPSHOT
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          if [[ "${VERSION}" == *"SNAPSHOT"* ]]; then
            echo "ERROR: Cannot deploy SNAPSHOT version to production"
            exit 1
          fi
          echo "âœ… Version ${VERSION} is valid for production"

      - name: Production Release Validation Summary
        run: |
          APP_NAME="${{ inputs.app_name }}"
          VERSION="${{ needs.build.outputs.version }}"
          IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
          
          echo "## ðŸ­ Production Release Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Application**: \`${APP_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: âœ… Built and Pushed" >> $GITHUB_STEP_SUMMARY
          echo "- **SonarQube**: ${{ needs.sonar-scan.result == 'success' && 'âœ… Passed' || (needs.sonar-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Validation**: âœ… Non-SNAPSHOT version confirmed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Ready for Production Deployment**" >> $GITHUB_STEP_SUMMARY

  # Deploy to prod environment (create PR with auto-merge)
  deploy-prod:
    name: deploy-prod (${{ matrix.name }})
    needs: [build, validate-prod-release]
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix: ${{ fromJson(needs.build.outputs.clusters_matrix) }}
    uses: ./.github/workflows/flux-deploy.yml
    with:
      app_name: ${{ inputs.app_name }}
      image_tag: ${{ needs.build.outputs.image_tag }}
      target_namespace: "prod"
      gitops_repo: ${{ matrix.gitops_repo }}
      cluster_path: ${{ matrix.cluster_path }}
      cluster_name: ${{ matrix.name }}
      commit_message_suffix: " - Production Release ${{ needs.build.outputs.version }}"
    secrets:
      CICD_TOKEN: ${{ secrets.CICD_TOKEN }}
      CICD_USER_EMAIL: ${{ secrets.CICD_USER_EMAIL }}
      CICD_USER_NAME: ${{ secrets.CICD_USER_NAME }}

  # Validate production deployment (after PR merge)
  validate-prod-deployment:
    name: validate-prod-deployment (${{ matrix.name }})
    needs: [build, deploy-prod]
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix: ${{ fromJson(needs.build.outputs.clusters_matrix) }}
    uses: ./.github/workflows/validate-flux-deployment.yml
    with:
      app_name: ${{ inputs.app_name }}
      image_tag: ${{ needs.build.outputs.image_tag }}
      target_namespace: "prod"
      cluster_name: ${{ matrix.name }}
      validation_timeout: 900  # Longer timeout for production
      cluster_url: ${{ matrix.cluster_url }}
    secrets:
      CLUSTER_CA_CERTIFICATE: ${{ secrets[format('K8S_CLUSTER_CA_CERT_FOR_{0}_CLUSTER', matrix.name)] }}
      SERVICE_ACCOUNT_TOKEN: ${{ secrets[format('SERVICE_ACCOUNT_TOKEN_FOR_{0}_CLUSTER_CICD_K8S_ACCESS', matrix.name)] }}

  # Workflow Summary
  workflow-summary:
    runs-on: arc-runners-javadev
    if: always()
    needs: [build, build-docker-image, sonar-scan, publish-openapi, deploy-dev, validate-dev-deployment, validate-prod-release, deploy-prod, validate-prod-deployment]
    steps:
      - name: Generate Workflow Summary
        run: |
          APP_NAME="${{ inputs.app_name }}"
          VERSION="${{ needs.build.outputs.version }}"
          IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
          IS_RELEASE="${{ needs.build.outputs.is_release }}"
          HAS_CLUSTERS="${{ needs.build.outputs.has_clusters }}"
          
          echo "# ðŸ“‹ Workflow Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Application Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Name**: \`${APP_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Build**: ${IS_RELEASE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Job Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          # Build status
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "| ðŸ—ï¸ Build & Test | âœ… Success | Application built and tested successfully |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ—ï¸ Build & Test | âŒ Failed | Build or tests failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Docker build status
          if [[ "${{ needs.build-docker-image.result }}" == "success" ]]; then
            echo "| ðŸ³ Docker Build | âœ… Success | Container image built and pushed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ³ Docker Build | âŒ Failed | Docker build failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # SonarQube status
          if [[ "${{ needs.sonar-scan.result }}" == "success" ]]; then
            echo "| ðŸ” SonarQube Scan | âœ… Success | Quality gate passed |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.sonar-scan.result }}" == "skipped" ]]; then
            echo "| ðŸ” SonarQube Scan | â­ï¸ Skipped | Commit message contains 'prepare for next development iteration' |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ” SonarQube Scan | âŒ Failed | Quality gate failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # OpenAPI spec publication
          if [[ "${{ needs.publish-openapi.result }}" == "success" ]]; then
            echo "| ðŸ“‹ OpenAPI Spec | âœ… Published | Spec published to API registry |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.publish-openapi.result }}" == "skipped" ]]; then
            echo "| ðŸ“‹ OpenAPI Spec | â­ï¸ Skipped | No spec found or skipped by commit message |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“‹ OpenAPI Spec | âŒ Failed | Spec publication failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Development deployment
          if [[ "${HAS_CLUSTERS}" == "true" && "${IS_RELEASE}" == "false" ]]; then
            if [[ "${{ needs.deploy-dev.result }}" == "success" ]]; then
              echo "| ðŸš€ Dev Deployment | âœ… Success | Deployed to development environment |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ðŸš€ Dev Deployment | âŒ Failed | Development deployment failed |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ "${{ needs.validate-dev-deployment.result }}" == "success" ]]; then
              echo "| âœ… Dev Validation | âœ… Success | Development deployment validated |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| âœ… Dev Validation | âŒ Failed | Development validation failed |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Production deployment (only for releases)
          if [[ "${IS_RELEASE}" == "true" ]]; then
            if [[ "${{ needs.validate-prod-release.result }}" == "success" ]]; then
              echo "| ðŸ­ Prod Validation | âœ… Success | Release validation passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ðŸ­ Prod Validation | âŒ Failed | Release validation failed |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ "${{ needs.deploy-prod.result }}" == "success" ]]; then
              echo "| ðŸš€ Prod Deployment | âœ… Success | Deployed to production environment |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ðŸš€ Prod Deployment | âŒ Failed | Production deployment failed |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ "${{ needs.validate-prod-deployment.result }}" == "success" ]]; then
              echo "| âœ… Prod Validation | âœ… Success | Production deployment validated |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| âœ… Prod Validation | âŒ Failed | Production validation failed |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "${{ needs.build.result }}" == "success" && "${{ needs.build-docker-image.result }}" == "success" ]]; then
            if [[ "${IS_RELEASE}" == "true" ]]; then
              if [[ "${{ needs.validate-prod-release.result }}" == "success" && "${{ needs.deploy-prod.result }}" == "success" && "${{ needs.validate-prod-deployment.result }}" == "success" ]]; then
                echo "## ðŸŽ‰ Overall Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
                echo "Production release completed successfully!" >> $GITHUB_STEP_SUMMARY
              else
                echo "## âŒ Overall Status: FAILED" >> $GITHUB_STEP_SUMMARY
                echo "Production release failed - check job details above." >> $GITHUB_STEP_SUMMARY
              fi
            else
              if [[ "${HAS_CLUSTERS}" == "true" ]]; then
                if [[ "${{ needs.deploy-dev.result }}" == "success" && "${{ needs.validate-dev-deployment.result }}" == "success" ]]; then
                  echo "## ðŸŽ‰ Overall Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
                  echo "Development deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
                else
                  echo "## âŒ Overall Status: FAILED" >> $GITHUB_STEP_SUMMARY
                  echo "Development deployment failed - check job details above." >> $GITHUB_STEP_SUMMARY
                fi
              else
                echo "## ðŸŽ‰ Overall Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
                echo "Build and Docker image creation completed successfully!" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "## âŒ Overall Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Build or Docker image creation failed - check job details above." >> $GITHUB_STEP_SUMMARY
          fi
      